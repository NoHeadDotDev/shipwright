!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ShipwrightLiveView={})}(this,function(t){"use strict";function e(t,n){null===t?n.push(192):!1===t?n.push(194):!0===t?n.push(195):"number"==typeof t?function(t,e){if(Number.isInteger(t))t>=0&&t<=127?e.push(t):t>=-32&&t<0?e.push(224|t+32):t>=-128&&t<=127?e.push(208,255&t):t>=-32768&&t<=32767?e.push(209,t>>8&255,255&t):(e.push(210),e.push(t>>24&255),e.push(t>>16&255),e.push(t>>8&255),e.push(255&t));else{const s=new DataView(new ArrayBuffer(8));s.setFloat64(0,t),e.push(203);for(let t=0;t<8;t++)e.push(s.getUint8(t))}}(t,n):"string"==typeof t?s(t,n):t instanceof Uint8Array?function(t,e){const s=t.length;s<=255?e.push(196,s):s<=65535&&e.push(197,s>>8&255,255&s);for(const n of t)e.push(n)}(t,n):Array.isArray(t)?function(t,s){const n=t.length;n<=15?s.push(144|n):n<=65535&&s.push(220,n>>8&255,255&n);for(const i of t)e(i,s)}(t,n):"object"==typeof t&&function(t,n){const i=Object.keys(t),o=i.length;o<=15?n.push(128|o):o<=65535&&n.push(222,o>>8&255,255&o);for(const r of i)s(r,n),e(t[r],n)}(t,n)}function s(t,e){const s=(new TextEncoder).encode(t),n=s.length;n<=31?e.push(160|n):n<=255?e.push(217,n):n<=65535&&e.push(218,n>>8&255,255&n);for(const i of s)e.push(i)}function n(t,e){const s=t.getUint8(e);if(192===s)return{value:null,offset:e+1};if(194===s)return{value:!1,offset:e+1};if(195===s)return{value:!0,offset:e+1};if(!(128&s))return{value:s,offset:e+1};if(!(224&~s))return{value:s-256,offset:e+1};if(160==(224&s)){return i(t,e+1,31&s)}if(144==(240&s)){return o(t,e+1,15&s)}if(128==(240&s)){return r(t,e+1,15&s)}switch(s){case 208:return{value:t.getInt8(e+1),offset:e+2};case 209:return{value:t.getInt16(e+1),offset:e+3};case 210:return{value:t.getInt32(e+1),offset:e+5};case 203:return{value:t.getFloat64(e+1),offset:e+9};case 217:const n=t.getUint8(e+1);return i(t,e+2,n);case 218:const a=t.getUint16(e+1);return i(t,e+3,a);case 220:const h=t.getUint16(e+1);return o(t,e+3,h);case 222:const u=t.getUint16(e+1);return r(t,e+3,u);case 196:const l=t.getUint8(e+1);return c(t,e+2,l);case 197:const f=t.getUint16(e+1);return c(t,e+3,f);default:throw new Error(`Unsupported MessagePack type: 0x${s.toString(16)}`)}}function i(t,e,s){const n=new Uint8Array(s);for(let i=0;i<s;i++)n[i]=t.getUint8(e+i);return{value:(new TextDecoder).decode(n),offset:e+s}}function o(t,e,s){const i=[];let o=e;for(let r=0;r<s;r++){const e=n(t,o);i.push(e.value),o=e.offset}return{value:i,offset:o}}function r(t,e,s){const i={};let o=e;for(let r=0;r<s;r++){const e=n(t,o);o=e.offset;const s=n(t,o);o=s.offset,i[e.value]=s.value}return{value:i,offset:o}}function c(t,e,s){const n=new Uint8Array(s);for(let i=0;i<s;i++)n[i]=t.getUint8(e+i);return{value:n,offset:e+s}}var a=(t=>(t[t.Connect=1]="Connect",t[t.Event=2]="Event",t[t.Heartbeat=3]="Heartbeat",t[t.Render=16]="Render",t[t.Diff=17]="Diff",t[t.Redirect=18]="Redirect",t[t.Command=19]="Command",t[t.Error=20]="Error",t[t.Ack=21]="Ack",t))(a||{}),h=(t=>(t[t.Replace=1]="Replace",t[t.Remove=2]="Remove",t[t.Insert=3]="Insert",t[t.Update=4]="Update",t[t.SetAttr=5]="SetAttr",t[t.RemoveAttr=6]="RemoveAttr",t[t.AddClass=7]="AddClass",t[t.RemoveClass=8]="RemoveClass",t[t.SetProp=9]="SetProp",t))(h||{}),u=(t=>(t[t.Show=1]="Show",t[t.Hide=2]="Hide",t[t.Toggle=3]="Toggle",t[t.AddClass=4]="AddClass",t[t.RemoveClass=5]="RemoveClass",t[t.SetAttribute=6]="SetAttribute",t[t.RemoveAttribute=7]="RemoveAttribute",t[t.Dispatch=8]="Dispatch",t[t.Push=9]="Push",t[t.Focus=10]="Focus",t[t.Blur=11]="Blur",t))(u||{});class l{static encode(t){return function(t){const s=[];return e(t,s),new Uint8Array(s)}(t)}static decode(t){return function(t){return n(new DataView(t),0).value}(t)}static createConnect(t,e){return{type:1,token:t,params:e}}static createEvent(t,e,s,n){return{type:2,event:t,element:e,value:s,metadata:n}}static createHeartbeat(){return{type:3,timestamp:Date.now()}}}class f{constructor(t){this.ws=null,this.reconnectAttempts=0,this.reconnectTimer=null,this.heartbeatTimer=null,this.messageQueue=[],this.isConnecting=!1,this.options={reconnectInterval:1e3,maxReconnectAttempts:10,heartbeatInterval:3e4,onOpen:()=>{},onClose:()=>{},onError:()=>{},onMessage:()=>{},...t}}connect(t,e){if(!(this.isConnecting||this.ws&&this.ws.readyState===WebSocket.OPEN)){this.isConnecting=!0;try{this.ws=new WebSocket(this.options.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat();const s=l.createConnect(t,e);for(this.send(l.encode(s));this.messageQueue.length>0;){const t=this.messageQueue.shift();this.ws.send(t)}this.options.onOpen()},this.ws.onmessage=t=>{try{const e=l.decode(t.data);this.handleMessage(e),this.options.onMessage(e)}catch(e){}},this.ws.onerror=t=>{this.isConnecting=!1,this.options.onError(t)},this.ws.onclose=()=>{this.isConnecting=!1,this.stopHeartbeat(),this.options.onClose(),this.scheduleReconnect()}}catch(s){this.isConnecting=!1,this.scheduleReconnect()}}}disconnect(){this.stopReconnect(),this.stopHeartbeat(),this.ws&&(this.ws.close(),this.ws=null),this.messageQueue=[]}send(t){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(t):this.messageQueue.push(t)}handleMessage(t){switch(t.type){case a.Error:case a.Ack:}}startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const t=l.createHeartbeat();this.ws.send(l.encode(t))}},this.options.heartbeatInterval)}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}scheduleReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts)return;this.stopReconnect();const t=Math.min(this.options.reconnectInterval*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectTimer=setTimeout(()=>{this.reconnectAttempts++,this.connect()},t)}stopReconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}get readyState(){return this.ws?this.ws.readyState:WebSocket.CLOSED}get isConnected(){return null!==this.ws&&this.ws.readyState===WebSocket.OPEN}}class d{constructor(t){this.root=t}applyPatches(t){for(const e of t)this.applyPatch(e)}applyPatch(t){const e=this.findNode(t.path);if(e)switch(t.op){case h.Replace:this.replace(e,t.data);break;case h.Remove:this.remove(e);break;case h.Insert:this.insert(e,t.data.index,t.data.html);break;case h.Update:this.update(e,t.data);break;case h.SetAttr:this.setAttribute(e,t.data.name,t.data.value);break;case h.RemoveAttr:this.removeAttribute(e,t.data);break;case h.AddClass:this.addClass(e,t.data);break;case h.RemoveClass:this.removeClass(e,t.data);break;case h.SetProp:this.setProperty(e,t.data.name,t.data.value)}}findNode(t){let e=this.root;for(const s of t){const t=e.children;if(s>=t.length)return null;e=t[s]}return e}replace(t,e){const s=document.createElement("div");s.innerHTML=e;const n=s.firstElementChild;n&&t.parentNode&&t.parentNode.replaceChild(n,t)}remove(t){t.remove()}insert(t,e,s){const n=document.createElement("div");n.innerHTML=s;const i=n.firstElementChild;i&&(e>=t.children.length?t.appendChild(i):t.insertBefore(i,t.children[e]))}update(t,e){if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement){const s=document.activeElement,n=t.selectionStart,i=t.selectionEnd;t.value=e,s===t&&void 0!==n&&t.setSelectionRange(n,i)}else t.textContent=e}setAttribute(t,e,s){t.setAttribute(e,s)}removeAttribute(t,e){t.removeAttribute(e)}addClass(t,e){t.classList.add(e)}removeClass(t,e){t.classList.remove(e)}setProperty(t,e,s){t[e]=s}}class m{constructor(t,e){this.listeners=new Map,this.debounceTimers=new Map,this.throttleTimers=new Map,this.element=t,this.websocket=e}start(){["click","dblclick","mousedown","mouseup","mouseover","mouseout","keydown","keyup","keypress","input","change","submit","focus","blur","focusin","focusout"].forEach(t=>{this.element.addEventListener(t,this.handleEvent.bind(this),!0)})}stop(){this.listeners.clear(),this.debounceTimers.forEach(t=>clearTimeout(t)),this.throttleTimers.forEach(t=>clearTimeout(t))}register(t,e,s={}){this.listeners.has(e)||this.listeners.set(e,new Map),this.listeners.get(e).set(t,s)}handleEvent(t){const e=t.target,s=this.listeners.get(t.type);if(s)for(const[n,i]of s)if(e.matches(n)){this.processEvent(t,n,i);break}}processEvent(t,e,s){s.preventDefault&&t.preventDefault(),s.stopPropagation&&t.stopPropagation();const n=`${t.type}:${e}`;s.debounce?this.debounce(n,()=>this.sendEvent(t,e),s.debounce):s.throttle?this.throttle(n,()=>this.sendEvent(t,e),s.throttle):this.sendEvent(t,e)}sendEvent(t,e){const s=t.target,n=this.extractValue(s),i=this.extractMetadata(t),o=l.createEvent(t.type,e,n,i);this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(l.encode(o))}extractValue(t){return t instanceof HTMLInputElement?"checkbox"===t.type||"radio"===t.type?t.checked:t.value:t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement?t.value:null}extractMetadata(t){const e={};return t instanceof MouseEvent?(e.x=t.clientX,e.y=t.clientY,e.button=t.button,e.ctrlKey=t.ctrlKey,e.shiftKey=t.shiftKey,e.altKey=t.altKey,e.metaKey=t.metaKey):t instanceof KeyboardEvent&&(e.key=t.key,e.code=t.code,e.ctrlKey=t.ctrlKey,e.shiftKey=t.shiftKey,e.altKey=t.altKey,e.metaKey=t.metaKey),e}debounce(t,e,s){const n=this.debounceTimers.get(t);n&&clearTimeout(n);const i=setTimeout(()=>{e(),this.debounceTimers.delete(t)},s);this.debounceTimers.set(t,i)}throttle(t,e,s){if(this.throttleTimers.has(t))return;e();const n=setTimeout(()=>{this.throttleTimers.delete(t)},s);this.throttleTimers.set(t,n)}}class v{execute(t){for(const e of t)this.executeCommand(e)}executeCommand(t){document.querySelectorAll(t.target).forEach(e=>{switch(t.type){case u.Show:this.show(e,t.transition);break;case u.Hide:this.hide(e,t.transition);break;case u.Toggle:this.toggle(e,t.transition);break;case u.AddClass:this.addClass(e,t.args);break;case u.RemoveClass:this.removeClass(e,t.args);break;case u.SetAttribute:this.setAttribute(e,t.args.name,t.args.value);break;case u.RemoveAttribute:this.removeAttribute(e,t.args);break;case u.Dispatch:this.dispatch(e,t.args);break;case u.Push:this.push(t.args);break;case u.Focus:this.focus(e);break;case u.Blur:this.blur(e)}})}show(t,e){e?this.applyTransition(t,e,()=>{t.style.display=""}):t.style.display=""}hide(t,e){e?this.applyTransition(t,e,()=>{t.style.display="none"}):t.style.display="none"}toggle(t,e){"none"===t.style.display||"none"===window.getComputedStyle(t).display?this.show(t,e):this.hide(t,e)}addClass(t,e){t.classList.add(...e.split(" "))}removeClass(t,e){t.classList.remove(...e.split(" "))}setAttribute(t,e,s){t.setAttribute(e,s)}removeAttribute(t,e){t.removeAttribute(e)}dispatch(t,e){t.dispatchEvent(new CustomEvent(e,{bubbles:!0}))}push(t){window.dispatchEvent(new CustomEvent("liveview:push",{detail:t}))}focus(t){t.focus()}blur(t){t.blur()}applyTransition(t,e,s){const n=e.duration||300,i=e.from||{},o=e.to||{};Object.assign(t.style,i),t.offsetHeight,t.style.transition=`all ${n}ms ease-in-out`,requestAnimationFrame(()=>{Object.assign(t.style,o)}),setTimeout(()=>{t.style.transition="",s()},n)}}class b{constructor(){this.forms=new Map,this.observer=null}start(t){this.saveAllForms(t),this.observer=new MutationObserver(t=>{t.forEach(t=>{"childList"===t.type&&(t.removedNodes.forEach(t=>{t instanceof Element&&this.saveForms(t)}),t.addedNodes.forEach(t=>{t instanceof Element&&this.restoreForms(t)}))})}),this.observer.observe(t,{childList:!0,subtree:!0})}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),this.forms.clear()}saveAllForms(t){t.querySelectorAll("form").forEach(t=>this.saveForm(t))}saveForms(t){if(t instanceof HTMLFormElement)this.saveForm(t);else{t.querySelectorAll("form").forEach(t=>this.saveForm(t))}}restoreForms(t){if(t instanceof HTMLFormElement)this.restoreForm(t);else{t.querySelectorAll("form").forEach(t=>this.restoreForm(t))}}saveForm(t){const e=this.getFormId(t);if(!e)return;const s=new FormData,n=t.elements;for(let i=0;i<n.length;i++){const t=n[i];t.name&&(t instanceof HTMLInputElement?"checkbox"===t.type||"radio"===t.type?t.checked&&s.append(t.name,t.value):"file"!==t.type&&"submit"!==t.type&&"button"!==t.type&&s.append(t.name,t.value):(t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&s.append(t.name,t.value))}this.forms.set(e,s)}restoreForm(t){const e=this.getFormId(t);if(!e)return;const s=this.forms.get(e);if(!s)return;const n=t.elements;for(let o=0;o<n.length;o++){const t=n[o];if(!t.name)continue;const e=s.getAll(t.name);0!==e.length&&(t instanceof HTMLInputElement?"checkbox"===t.type||"radio"===t.type?t.checked=e.includes(t.value):"file"!==t.type&&(t.value=e[0]):(t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&(t.value=e[0]))}const i=document.activeElement;if(i&&t.contains(i)&&(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement)){const t=i.selectionStart;null!==t&&i.setSelectionRange(t,t)}}getFormId(t){return t.id||t.name||(t.action?btoa(t.action):null)}}class p{constructor(t){if(this.domPatcher=null,this.eventDelegator=null,this.t="",this.options=t,"string"==typeof t.container){const e=document.querySelector(t.container);if(!e)throw new Error(`Container element not found: ${t.container}`);this.container=e}else this.container=t.container;this.connection=new f({url:t.url,reconnectInterval:t.reconnectInterval,maxReconnectAttempts:t.maxReconnectAttempts,heartbeatInterval:t.heartbeatInterval,onOpen:()=>{var e;null==(e=t.onConnect)||e.call(t)},onClose:()=>{var e;null==(e=t.onDisconnect)||e.call(t)},onError:e=>{var s;null==(s=t.onError)||s.call(t,e)},onMessage:this.handleMessage.bind(this)}),this.commandExecutor=new v,this.formRecovery=new b}get fingerprint(){return this.t}connect(){this.connection.connect(this.options.token,this.options.params)}disconnect(){this.cleanup(),this.connection.disconnect()}pushEvent(t,e={},s){const n=l.createEvent(t,void 0,e);this.connection.send(l.encode(n))}handleMessage(t){switch(t.type){case a.Render:this.handleRender(t);break;case a.Diff:this.handleDiff(t);break;case a.Command:this.handleCommand(t);break;case a.Redirect:this.handleRedirect(t);case a.Error:}}handleRender(t){this.cleanup(),this.t=t.fingerprint,this.container.innerHTML=t.html,this.domPatcher=new d(this.container),this.eventDelegator=new m(this.container,this.connection.ws),this.eventDelegator.start(),this.formRecovery.start(this.container),t.assets&&this.loadAssets(t.assets),this.bindEvents()}handleDiff(t){this.domPatcher&&(this.t=t.fingerprint,this.domPatcher.applyPatches(t.patches),this.bindEvents())}handleCommand(t){this.commandExecutor.execute(t.commands)}handleRedirect(t){t.replace?window.location.replace(t.url):window.location.href=t.url}bindEvents(){if(!this.eventDelegator)return;this.container.querySelectorAll("[lv-click], [lv-submit], [lv-change], [lv-keyup], [lv-keydown], [lv-blur], [lv-focus]").forEach(t=>{const e=t.attributes;for(let s=0;s<e.length;s++){const n=e[s];if(n.name.startsWith("lv-")){const e=n.name.substring(3),s=this.getSelector(t),i=this.parseEventConfig(n.value);this.eventDelegator.register(s,e,i)}}})}getSelector(t){if(t.id)return`#${t.id}`;const e=Array.from(t.attributes).filter(t=>t.name.startsWith("data-")).map(t=>`[${t.name}="${t.value}"]`).join("");if(e)return`${t.tagName.toLowerCase()}${e}`;const s=Array.from(t.classList).map(t=>`.${t}`).join("");return`${t.tagName.toLowerCase()}${s}`}parseEventConfig(t){const e=t.split(":"),s={};return e.forEach(t=>{"prevent"===t?s.preventDefault=!0:"stop"===t?s.stopPropagation=!0:t.startsWith("debounce-")?s.debounce=parseInt(t.substring(9)):t.startsWith("throttle-")&&(s.throttle=parseInt(t.substring(9)))}),s}loadAssets(t){t.css&&t.css.forEach(t=>{if(!document.querySelector(`link[href="${t}"]`)){const e=document.createElement("link");e.rel="stylesheet",e.href=t,document.head.appendChild(e)}}),t.js&&t.js.forEach(t=>{if(!document.querySelector(`script[src="${t}"]`)){const e=document.createElement("script");e.src=t,e.async=!0,document.head.appendChild(e)}})}cleanup(){this.eventDelegator&&(this.eventDelegator.stop(),this.eventDelegator=null),this.formRecovery.stop(),this.domPatcher=null}}"undefined"!=typeof window&&document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("[data-liveview-url]").forEach(t=>{const e=t.getAttribute("data-liveview-url"),s=t.getAttribute("data-liveview-token");if(e){const n=new p({url:e,container:t,token:s||void 0});n.connect(),t.i=n}})}),t.LiveView=p,t.MessageType=a,t.Protocol=l,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
